# 클라우드 인프라 개념정리

## 클라우드 환경에서 판매 상품 유형

- SaaS [Software as a Searvice] : 애플리케이션 환경 제공 서비스 (애플리케이션 프로그램)
- PaaS [Platform as a Service] : 개발 및 운영환경 제공 서비스 (미들웨어, 프레임워크)
- IaaS [Infrastructure as a Service] : 가상화 된 시스템 인프라 제공 서비스 (서버, 네트워크, storage, OS)

이중 IaaS를 활용하기위한 전체적인 구조 및 **AWS**나 **오픈스택**을 예로 개념적인 부분들을 정리 합니다.

## 클라우드 환경 구성 요소

### 테넌트

> 클라우드 서비스 사용자만의 환경, AWS의 계정이 테넌트에 해당한다.

#### 테넌트 설계 시 고려사항 (테넌트 특징)

- 공용 클라우드에서는 테넌트별로 리소스의 사용량이 합산되어 테넌트별로 사용료가 청구 됨
- 테넌트별로 사용 가능한 리소스의 상한선이 정해져 있음
- 같은 테넌트에 속한 가상 네트워크, 가상 머신 인스턴스, 가상 스토리지들끼리만 서로 연결될 수 있음

### 리전

> aws는 지역별로 데이터센터들을 분산 시켜 운영하는데 이때 지역별 데이터센터(서버컴퓨터와 네트워크 회선)들을 군집화한 지역을 <strong>리전(region)</strong>이라고 부릅니다.

- 각 테넌트들을 모든 리전을 사용할 수 있고
- 이를 통해 DR(disaster recovery)환경을 구성 할수 있습니다. 서울리전에 문제가 생겼을시 다른 리전에서 운영이 가능하다. 하지만 리전별로 부여되어있는 공인 IP의 범위가 다르기 때문에 현재 사용중이던 리전의 공인 IP를 변경된 리전의 공인 IP로 수정해 줘야한다.
- 각 테넌트가 모든 리전을 이용할수는 있지만 여러리전에 걸친 한가지의 가상 네트워크를 만들수는 없다.

### 가용영역(AZ : availability zone)

> 같은 리전 내부에 여러개의 데이터센터가 있는데 이들을 일컬어 가용 영역이라 부릅니다.

- 한 리전 내에있는 AZ는 100km(60마일) 이내의 거리에 위치한다.
- AZ 간에 높은 처리량과 지연 시간이 짧은 네트워킹을 제공
- AZ별로의 DR환경을 또한 구성이 가능하다.
- 각각 다른 가용 영역에 있는 가상 머신 인스턴스와 블록 스토리지는 서로 연결할 수 없다.

## 네트워크 리소스

### 가상 사설 클라우드 (VPC: Virtual Private Cloud)와 라우터

> 외부의 접근이 제한된 가상 사설 네트워크(VPC)
> VPC와 외부망을 연결해주는 역할(라우터)

aws에서 VPC라는 개인 사설 클라우드가 있는데 이는 개념적으로 ISP와 개인 공유기와의 관계로 이해하면 더 좋을것 같습니다.

개인 테넌트를 통해 VPC를 만들어 VPC에 인스턴스를 생성하면, 집에서 공유기에 개인 단말기 하나를 연결한 것과 같은 모양이 됩니다.

이렇게 VPC는 외부의 접근을 제한하는 사설 네트워크가 됩니다. 여기서 외부와 통신하기위해 가상의 라우터를 통해 외부와 라우팅합니다.

aws는 리전별로 여러개의 VPC를 구성이가능하고, 오픈스택은 리전별 하나의 VPC를 구성 가능합니다.


#### CIDR(Classless Inter Domain Routing)

CIDR은 기존 클래스로 나눠서 사용하던 방식이 유연하지 못해서, CIDR을 통해 조금 더 세분화시켜 관리할 수 있도록 만들어진 방법입니다.

`172.31.0.0/24`

위를 예시로 /24로 표기되어 있기 때문에 앞에서 부터 24비트까지가 고정이고 이후 남은 8비트로 블록이 할당되된다. 활용 예로 [이 부분](https://ko.wikipedia.org/wiki/%EC%82%AC%EC%9D%B4%EB%8D%94_(%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9)#%EC%82%AC%EC%9D%B4%EB%8D%94_%EB%B8%94%EB%A1%9D%EC%9D%98_%ED%95%A0%EB%8B%B9)을 읽어보면 좋을것 같다.

### 스위치(서브넷)

> 가상 스위치는 가상 라우터와 가상 머신 인스턴스의 가상 NIC가 연결되는 접점

<span style="color:#999999">\* NIC(Network Interface Card) : 컴퓨터에서 랜선을 통해 연결되는 IOS 1,2계층의 연결을 돕는 하드웨어 장치이다. 이또한 가상화를 통해 스위치와 인스턴스를 연결한다. </span>

- 가상 스위치 하나에 서브넷(인스턴스가 사용할 수 있는 사설 IP 주소 범위)이 하나 할당 됨
- aws는 스위치와 서브넷을 하나로 통합된 형태로 취급해 오픈스택처럼 스위치를 정의후 서브넷을 할당하는게아닌 서브넷 기능으로만 활용 함
- 가상 스위치이기 때문에 물리적인 스위치와 다르게 포트의 수를 늘리기위해 추가적인 설치가 필요 없고, 인스턴스를 연결할때 포트를 추가하고 가상 NIC와 연결 한다.

### 공인 IP 주소

> VPC에서 사용하는 사설 IP주소는 외부망과 접속시 사용불가, 그래서 공인IP로 변환 작업이 필요

1. IP 마스커레이딩
   > 동일한 공인 IP주소를 공유하는 방식

    - 가상 라우터가 할당 받은 공인 IP를 공유하는 방식
    - `가상 머신 인스턴스 <-> 가상 스위치 <-> 가상 라우터` 이렇게 연결되어 있으면 사용 가능
    - 외부 네트워크에서 가상머신 방향으로 접속이 **허용되지 않음**(내부에서 외부는 가능)
2. 엘라스틱 IP(aws), 플로팅 IP(오픈스택)
   > 미리 개별적으로 확보해 둔 공인 IP 주소를 가상 머신 인스턴스에 할당하는 방식

   - 내부에서 외부, 외부에서 내부 쌍방향으로 통신이 가능함 

### 시큐리티 그룹

> 가상 머신 인스턴스가 주고 받을 네트워크 패킷에 대해 필더링 기능을 제공하는 역할

인스턴스에 적용하는 방식으로 시큐리티 그룹을 생성해 그룹별 조건을 정할 수 있습니다. 

공용 시큐리티 그룹으로 ssh 접속과 같이 원격 접속시 반드시 필요한 규칙을 정의하고, 웹 서버같은 경우는 HTTP/HTTPS허용 과같은 추가적인 보안 요소를 정하여 사용합니다. 

## 서버 리소스

서버 리소스인 가상 머신 인스턴스를 기동하기 위해 필요한 설정 정보들을 정리합니다.

### 템플릿 이미지 
 
> 게스트 OS로 설치할 사전 준비된 이미지

게스트 OS가 설치된 기동 디스크가 있어야 가상 머신 인스턴스를 기동할 수 있습니다. 그래서 도커 이미지와 같이 사전에 준비된 템플릿 이미지를 선택해 사용한다고 합니다.

템플릿 이미지는 클라우드 서비스 제공자가 미리 준비해두기도 하지만 직접 만든걸 활용 할 수도 있습니다.

### 인스턴스 유형

> 가상 머신의 컴퓨팅 성능 및 용량을 결정 

- AWS는 클라우드 이용자가 새로운 인스턴스 유형을 직접 만들 순 없음
- 오픈스택에서는 테넌트의 관리 권한이 있는 사용자가 직접 유형을 변경 가능

인스턴스 유형의 설정 항목
- 가상 CPU
- 메모리
- 루트 디스크
- 임시 디스크
- 스왑 디스크

인스턴스 유형 항목 중 `루트 디스크`가 있는데 이는 템플릿 이미지를 복제해서 만들어진 기동디스크 입니다. 인스턴스 기동시 루트, 임시 디스크는 이페머럴(수명이 짧은) 디스크에 해당하고 인스턴스 종료 및 파괴시 데이터가 함께 사라집니다. 

영속적으로 보존 해야하는 데이터는 별도의 [블록 스토리지](#블록-스토리지-리소스)  혹은 [오브젝트 스토리지](#오브젝트-스토리지-리소스)에 보존해야 합니다.

스냅샷 : 인스턴스가 기동되고 루트 디스크에 애플리케이션을 설치하고 각종 설정을 한 후에 사용하게 됩니다. 이러한 설정이된 루트 디스크를 복제해 템플릿 이미지로 만들어 재사용 가능하게 해주는 기능입니다.

### 로그인 인증과 키페어

인스턴스의 게스트 OS에 로그인 할떄 사용자 인증으로 SSH의 공개 키 인증 방식이 사용됩니다. 태넌트 이용자는 키 페어를 만들게 되고 공개키는 클라우드 환경에 미리 등록되고 개인키는 사용자가 다운 받습니다. 이후 ssh로 접속시 개인키를 사용해 접속하게 됩니다.


## 블록 스토리지 리소스

AWS에서 EBS(Elastic Block Storage)라고하는 가상 머신 인스턴스가 종료하거나 파괴되더라도 내용을 보존할 수 있는 영속적인 디스크 영역입니다.

### 블록 스토리지의 기본 사용법

- 볼륨(디스크)을 용량지정과 함께 생성 후 가상 머신 인스턴스에 연결
- 게스트 OS가 디스크 디바이스가 새로 추가된 것으로 인식
- 물리적인 디스크 디바이스처럼 사용

### EBS Boot (aws)

> 블록스토리지에 가상 머신 인스턴스 기동

- 템플릿 이미지를 복제한 볼륨을 미리 만들어 둠
- 가상 머신 인스턴스를 기동할 때 제공되는 템플릿이미지 대신 미리 복제한 볼륨을 지정

위처럼 기동시 인스턴스 종료를 하더라도 OS 영역데이터가 보존되어 종료 직전의 구성으로 설정된 게스트 OS를 재사용 할 수 있습니다.

## 오브젝트 스토리지 리소스

오브젝트 스토리지 : 파일 단위로 데이터를 저장하는 데이터 스토어

가상 머신 인스턴스의 게스트 OS와 외부네트워크에서 직접 접근 가능한 스토리지입니다. (aws의 S3)

### 오브젝트 스토리지 기본 기능

- 파일 단위로 데이터를 저장하는 기능 제공
- 이미 저장된 파일을 바꾸고 싶어도 덮어쓰기를 지원하지 않음(파일 삭제 후 새로 삽입해야 함)
- 정적 콘텐츠 파일 저장하기 적합
- 장소나 지역에 상관없이 인터넷을 통해 접속해 이용 가능
- aws S3 버킷
  - 오브젝트를 담을 컨테이너이다. 계층 구조를 지원하지 않지만 별칭처럼 사용가능하고 `dir01/file01`과 같이 사용이 가능한데 실제로 디렉토리 안에 파일이 들어있는게 아닌 이름만 `dir01/file01`로 저장되는것이다.

### 버저닝과 정적 웹 호스팅

#### 버저닝

> 컨테이너에 저장된 오브젝트에 버전 번호를 붙여 관리하는 기능

같은 이름의 파일을 저장하면 기존 파일에 덮어 쓰는게 앙닌 새로운 버전 번호로 파일을 저장합니다. 과거 버전의 파일이 지워지지 않기 때문에 버전 번호를 지정시 과거 파일 내용또한 사용 가능합니다.


#### 정적 웹 호스팅

> 오브젝트 스토리지를 간이 웹서버처럼 사용하는 기능

컨테이너 접근 권한을 누구나 읽을 수 있도록 수정하고 HTML파일을 젖아하면 됩니다. 이후 오브젝트에 할당된 URL로 접속시 파일이 표시 됨

### 오브젝트 스토리지 백업

> 블록 스토리지의 볼륨을 백업 하는 용도로 오브젝트 스토리지를 사용

- 블록 스토리지의 볼륨 전체를 일정 크기의 블록으로 분할 후 각각의 조각을 하나의 파일 형태로 간주해 저장하는 방식
- 오브젝트 스토리지가 여러 리전과 가용 영역에 제한 없이 접근 가능하기 때문에 리전이나 가용 영역간의 볼륨 복제로 활용

